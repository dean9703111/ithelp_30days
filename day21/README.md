#### [å›ç›®éŒ„](../README.md)
## Day21 Google Sheets-çˆ¬èŸ²è³‡æ–™å¡éŒ¯ä½ç½®äº†! & èˆ‡å®¢æˆ¶æºé€šbugçš„æŠ€å·§

>å®¢æˆ¶çš„æ“ä½œè·Ÿä½ æƒ³çš„ä¸ä¸€æ¨£

ğŸ¤” ç‚ºä»€éº¼å¯«é€™ç¯‡æ–‡ç« ï¼Ÿ
----
å…¶å¯¦é€™ä»½å°ˆæ¡ˆå®Œæˆåˆ°æ˜¨å¤©çš„é€²åº¦æ™‚å°±çµ¦æ¥­ä¸»åšåŠŸèƒ½ä¸Šçš„ç¢ºèªæº–å‚™çµæ¡ˆäº†  
ä½†ä¸€å€‹æ¡ˆå­é€šå¸¸å¾ˆé›£ä¸€æ¬¡å°±é€šéï¼Œ`ç„¡è«–é€™éš»ç¨‹å¼åœ¨ä½ é›»è…¦ä¸ŠåŸ·è¡Œçš„å¤šéº¼ç©©å®šï¼Œæ”¾åˆ°åˆ¥äººçš„é›»è…¦ä¸Šç¸½æœƒå†’å‡ºå¤§å¤§å°å°çš„bug`ï¼Œæˆ‘å¤§æ¦‚æ­¸é¡æˆä»¥ä¸‹å¹¾ç¨®ï¼š
1. ä½œæ¥­ç³»çµ±ä¸åŒå°è‡´çš„
    * Windowsã€MacOSã€Ubuntu Linux (exï¼šçˆ¬èŸ²æ™‚éœ€è¦è¨­å®šå„è‡ªçš„ webdriver)
2. å¥—ä»¶ç‰ˆæœ¬ä¸åŒå°è‡´
    * Node.jsç‰ˆæœ¬ã€npm å¥—ä»¶ (exï¼šæœ‰äº› npmå¥—ä»¶åªèƒ½åœ¨ç‰¹å®š Node.jsç‰ˆæœ¬é‹è¡Œ)
3. é›»è…¦é‹è¡Œç’°å¢ƒ
    * ç¶²è·¯é€Ÿåº¦ã€ç¡¬é«”è¦æ ¼... (exï¼šå¦‚æœä½ çš„ç¶²è·¯ç’°å¢ƒå¤ªå·®éœ€è¦å»èª¿æ•´çˆ¬èŸ²å…ƒä»¶çš„æ¥µé™ç­‰å¾…æ™‚é–“)
4. `å®¢æˆ¶çš„æ“ä½œè·Ÿä½ é æƒ³çš„ä¸ä¸€æ¨£`

ç¬¬ 1ã€2ã€3 é»çš„å•é¡Œæˆ‘åœ¨ä¹‹å‰æ–‡ç« å¯¦ä½œç¢°åˆ°æ™‚æœ‰æåˆ°éï¼Œä»Šå¤©ä¾†è¬›è¬›`å¯¦éš›ä¸Šä½ æœƒæœ€å´©æ½°çš„ç¬¬ 4 é»`

----

ğŸ† ä»Šæ—¥ç›®æ¨™
----
### 1. å°‡å®¢æˆ¶ç™¼çš„bugåšåŸºç¤åˆ†é¡
### 2. å¼•å°å®¢æˆ¶èªªå‡ºbugç™¼ç”ŸåŸå› åŠæå‡ºè§£æ±ºæ–¹æ¡ˆçš„å°æŠ€å·§
### 3. é‡ç¾å®¢æˆ¶ç™¼ç”Ÿçš„bug
### 4. æ”¹å¯«ç¨‹å¼è®“æ–°çš„çˆ¬èŸ²è³‡æ–™å¡å…¥æ­£ç¢ºä½ç½®
4.1 å–å¾—Google Sheetsç¬¬ä¸€æ¬„çš„ç²‰å°ˆåç¨±ï¼š`readTitle`
4.2 è®“æ–°çš„çˆ¬èŸ²è³‡æ–™æ­£ç¢ºå¯«å…¥Google Sheetsï¼š`writeSheet`

----

# 1. å°‡å®¢æˆ¶ç™¼çš„bugåšåŸºç¤åˆ†é¡
èˆ‡ä½ åˆä½œçš„å®¢æˆ¶é€šå¸¸ä¸æ˜¯è³‡å·¥ç›¸é—œèƒŒæ™¯ï¼Œä»–å€‘æ‰€æå‡ºä¾†çš„bugæœ‰æ™‚ä¹Ÿæœƒè®“ä½ å•¼ç¬‘çš†éï¼Œæˆ‘å€‹äººæœƒå°‡ä»–å€‘æå‡ºçš„ bugåˆ†æˆ 3 ç¨®
* **æ˜é¡¯çš„bug**ï¼šå®¢æˆ¶ä¸€å ±bugä½ å°±çŸ¥é“å“ªå€‹ç’°ç¯€å‡ºå•é¡Œäº†ï¼Œå°±èªå‘½åœ°è§£æ±ºå§ (exï¼šè‡‰æ›¸çš„çˆ¬èŸ²ç™»å…¥å¾Œå°±å¡ä½ä¸å‹•äº†)
* **éœ€è¦è¨è«–çš„bug**ï¼š`å®¢æˆ¶å ±bugæ™‚ä½ ä¸ç¢ºå®šæ˜¯å“ªå€‹ç’°ç¯€å‡ºäº†å•é¡Œï¼Œéœ€è¦èˆ‡å®¢æˆ¶è¨è«–ç™¼ç”Ÿbugçš„æ“ä½œæµç¨‹`
* **ä¸åˆç†çš„bug**ï¼šæ˜é¡¯ä¸åˆç†çš„è¦æ±‚ (exï¼šç¨‹å¼åŸ·è¡Œåˆ°ä¸€åŠä½¿ç”¨è€…æŠŠé›»è…¦é—œæ©Ÿå•ä½ çˆ¬èŸ²è³‡æ–™ç‚ºä»€éº¼æ²’æœ‰å¯«å…¥Google Sheets)

----

# 2. å¼•å°å®¢æˆ¶èªªå‡ºbugç™¼ç”ŸåŸå› åŠæå‡ºè§£æ±ºæ–¹æ¡ˆçš„å°æŠ€å·§
å¾ˆå¤šæ™‚å€™å®¢æˆ¶å°æ–¼bugçš„é™³è¿°æ˜¯å¾ˆæ¨¡ç³Šçš„ï¼Œæ‰€ä»¥ä½ **éœ€è¦èˆ‡å®¢æˆ¶æºé€šï¼Œå¼•å°ä»–å€‘èªªå‡ºè‡ªå·±çš„æ“ä½œæµç¨‹**ï¼Œä»¥ä»Šå¤©ç™¼å‡ºçš„Bugåšèˆ‰ä¾‹ï¼š

**å®¢æˆ¶**ï¼šä»Šå¤©çˆ¬èŸ²è³‡æ–™å¯«å…¥ Google Sheetsè¡¨å–®æ™‚å¡éŒ¯ä½ç½®äº†ï¼
**æˆ‘**ï¼šè«‹å•é€™å€‹å•é¡Œæ˜¯ä»Šå¤©çªç„¶ç™¼ç”Ÿçš„ï¼Œé‚„æ˜¯éå»å¹¾å¤©ä¹Ÿç™¼ç”Ÿéé€šæ¨£çš„å•é¡Œå‘¢ï¼Ÿï¼ˆ`é‡æ¸…bugç™¼ç”Ÿçš„æ™‚é–“é»`ï¼‰
**å®¢æˆ¶**ï¼šæ˜¯ä»Šå¤©æ‰ç™¼ç”Ÿçš„
**æˆ‘**ï¼šé‚£ä»Šå¤©ä½ åœ¨è·‘çˆ¬èŸ²å‰æœ‰åšéä»€éº¼èª¿æ•´å—ï¼Ÿ (`ç¢ºèªæ˜¯ä»€éº¼æ¨£çš„æ“ä½œå°è‡´bug`)
**å®¢æˆ¶**ï¼šæˆ‘åœ¨çˆ¬èŸ²çš„jsonæª”è£¡é¢æ–°å¢äº†å¹¾å€‹ç²‰å°ˆï¼Œç„¶å¾ŒæŠŠGoogle Sheetsä¸Šé¢ä¸€äº›æ²’æœ‰åœ¨ç¶­è­·çš„ç²‰å°ˆçµ¦ç æ‰
**æˆ‘**ï¼šäº†è§£ï¼Œæˆ‘é€™é‚Šæœƒå…ˆé‡è¤‡ä¸€éæ‚¨çš„æ“ä½œä¾†é‡æ¸…å•é¡Œï¼Œæœ€æ™šæœƒåœ¨å…©å¤©å¾Œçµ¦æ‚¨ç­”è¦† (`è‡ªå·±æ“ä½œä¸€éç¢ºèªæœ‰é€™å€‹bug`)
===æˆ‘æ˜¯æ­£åœ¨é‡ç¾bugçš„åˆ†éš”ç·š===
**æˆ‘**ï¼šæˆ‘é€™é‚Šä¾ç…§æ‚¨çš„æ–¹å¼åšäº†æ“ä½œï¼Œç¢ºå¯¦é‡åˆ°é€™å€‹å•é¡Œï¼›é€™é‚Šæˆ‘æå‡ºä¸€å€‹è§£æ±ºæ–¹æ¡ˆï¼Œæ¡ç”¨é€™å€‹æ–¹æ¡ˆä½ æ–°å¢çš„çˆ¬èŸ²ç²‰å°ˆæœƒå¯«å…¥Google Sheetsè¡¨å–®çš„æœ€ä¸‹é¢ï¼Œä¸”è¿½è¹¤äººæ•¸éƒ½æœƒå¡«å…¥æ­£ç¢ºæ¬„ä½ï¼Œè©³ç´°é‚è¼¯ä½ å¯ä»¥åƒè€ƒä¸‹æ–¹èªªæ˜ (`è‡ªå·±æå‡ºè§£æ±ºæ–¹æ¡ˆï¼Œåƒè¬åˆ¥è®“å®¢æˆ¶å¤©é¦¬è¡Œç©ºäº‚æ`)
>* å°è‡´éŒ¯èª¤ç™¼ç”Ÿçš„æ“ä½œï¼š
    1. äººå·¥æ•´ç† Google Sheetsç²‰å°ˆåç¨±çš„æ¬„ä½ï¼šåˆªé™¤ã€ä¸Šä¸‹ç½®æ›
    2. èª¿æ•´çˆ¬èŸ²jsonå…§å®¹ï¼šæ–°å¢/åˆªé™¤/ä¸Šä¸‹ç½®æ›
>* è§£æ±ºéŒ¯èª¤çš„æ–¹å¼ï¼š
    1. ç²‰å°ˆåç¨±ï¼šå¯«å…¥å‰å°‡Google Sheetsä¸Šç²‰å°ˆåç¨±çš„æ¬„ä½èˆ‡çˆ¬èŸ²jsonæ¯”å°ï¼Œå¦‚æœ **çˆ¬èŸ²jsonè£¡é¢æœ‰æ–°çš„ç²‰å°ˆå°±æœƒæ–°å¢åˆ°æœ€ä¸‹é¢ï¼Œä¸æ”¹è®ŠGoogle Sheetsä¸Šç²‰å°ˆåç¨±åŸæœ‰æ’åˆ—é †åº**
    2. è¿½è¹¤äººæ•¸ï¼šä»¥ **ç²‰å°ˆåç¨±+ç²‰å°ˆç¶²å€ä½œç‚ºå¯«å…¥è¿½è¹¤äººæ•¸æ¬„ä½çš„åˆ¤æ–·**

**å®¢æˆ¶**ï¼šå¥½çš„å…ˆé€™æ¨£åšå§ï¼Œä½ ä»€éº¼æ™‚å€™èƒ½æ”¹å¥½ï¼Ÿ
**æˆ‘**ï¼šé è¨ˆä¸‰å€‹å·¥ä½œå¤©ï¼Œå¦‚æœææ—©å®Œæˆæœƒå„˜æ—©èˆ‡æ‚¨è¯ç¹« (`èªªä¸€å€‹ä½ çµ•å°èƒ½å®ŒæˆåŠŸèƒ½çš„æ™‚é–“ï¼Œä¸¦è¡¨é”ç©æ¥µæ€§`)

----

# 3. é‡ç¾å®¢æˆ¶ç™¼ç”Ÿçš„bug
>é€™å€‹æ­¥é©Ÿéå¸¸é‡è¦ï¼Œ`å¦‚æœbugç„¡æ³•åœ¨è‡ªå·±çš„ç’°å¢ƒé‡ç¾æ™‚ä½ æœƒè¶…ç´šé ­å¤§`ï¼Œå› ç‚ºç«™åœ¨å®¢æˆ¶çš„è§’åº¦å°±æ˜¯èªç‚ºä½ æ²’æœ‰å®Œæˆå°ˆæ¡ˆï¼Œé€™æœƒå°è‡´ä½ çµæ¡ˆçš„æ—¥å­è®Šå¾—é™é™ç„¡æœŸ...

é€™å€‹å•é¡Œé‡ç¾èµ·ä¾†éå¸¸ç°¡å–®ï¼Œå»ºè­°è®€è€…è‡ªå·±å¯¦é©—çœ‹çœ‹
1. å°‡ fb.json ä¸­çš„'éº»ç³¬çˆ¸æ„›äº‚ç•«'åˆªé™¤ï¼Œç„¶å¾ŒæŠŠ'å¯¶å¯¶ä¸èªª'ç§»åˆ°ç¬¬äºŒå€‹
    ```json
    [
        
        {
            "title": "é¹¿å°¼",
            "url": "https://www.facebook.com/%E9%B9%BF%E5%B0%BC-260670294340690/"
        },
        {
            "title": "å¯¶å¯¶ä¸èªª",
            "url": "https://www.facebook.com/baobaonevertell/"
        },
        {
            "title": "å¥½æƒ³å…”",
            "url": "https://www.facebook.com/chien760608/"
        },
        {
            "title": "ã„‡ã„šËŠå¹¾å…”",
            "url": "https://www.facebook.com/machiko324/"
        }
    ]
    ```
2. åŸ·è¡Œç¨‹å¼ **yarn start** å¾Œä½ å°±æœƒç™¼ç¾excelçš„è¡¨æ ¼äº‚æ‰äº†  
    ![image](./article_img/googlesheetserr.png)  

----

# 4. æ”¹å¯«ç¨‹å¼è®“æ–°çš„çˆ¬èŸ²è³‡æ–™å¡å…¥æ­£ç¢ºä½ç½®
### 4.1 å–å¾—Google Sheetsç¬¬ä¸€æ¬„çš„ç²‰å°ˆåç¨±ï¼š`readTitle`
* ç•¶é€™å€‹sheetå…¨æ–°çš„æ™‚å€™å…§å®¹æ˜¯ undefineï¼Œä½†æ˜¯å› ç‚ºæˆ‘å€‘ç­‰ç­‰å†åšå°æ¯”æ™‚ç”¨çš„æ ¼å¼ç‚ºarrayï¼Œæ‰€ä»¥è¦çµ¦ä»–ä¸€å€‹åˆå§‹å‹åˆ¥
```js
async function readTitle (title, auth) {
    const sheets = google.sheets({ version: 'v4', auth });
    const request = {
    spreadsheetId: process.env.SPREADSHEET_ID,
    ranges: [
        `'${title}'!A:A`
    ],
    valueRenderOption: "FORMULA"
    }
    try {
    let title_array = []
    let values = (await sheets.spreadsheets.values.batchGet(request)).data.valueRanges[0].values;
    if (values) {//å¦‚æœæ²’è³‡æ–™valuesæœƒæ˜¯undefineï¼Œæ‰€ä»¥æˆ‘å€‘åªåœ¨æœ‰è³‡æ–™æ™‚å¡å…¥
        title_array = values.map(value => value[0]);
    }
    // console.log(title_array)
    return title_array
    } catch (err) {
    console.error(err);
    }
}
```
### 4.2 è®“æ–°çš„çˆ¬èŸ²è³‡æ–™æ­£ç¢ºå¯«å…¥Google Sheetsï¼š`writeSheet`
æˆ‘å€‘ä¾ç…§å®¢æˆ¶æ¥å—çš„`è§£æ±ºæ–¹æ¡ˆ`ä¾†èª¿æ•´é€™éš»å‡½å¼
* å°‡çˆ¬èŸ²json ä¸­æ–°å¢çš„ç²‰å°ˆ`è£œåˆ° Google Sheetsæœ€å¾Œé¢`
* è¿½è¹¤äººæ•¸ç”¨`ç²‰å°ˆåç¨±+ç²‰å°ˆç¶²å€`ä¾†å¡å…¥å°æ‡‰çš„ä½ç½®
```js
async function writeSheet (title, result_array, auth) {
  // å–å¾—ç·šä¸Šç¬¬ä¸€æ¬„çš„ç²‰å°ˆåç¨±
  let online_title_array = await readTitle(title, auth)
  // å¦‚æœjsonæª”æœ‰æ–°å¢çš„ç²‰å°ˆå°±è£œåˆ°æœ€å¾Œé¢
  result_array.forEach(fanpage => {
    if (!online_title_array.includes(`=HYPERLINK("${fanpage.url}","${fanpage.title}")`)) {
      online_title_array.push(`=HYPERLINK("${fanpage.url}","${fanpage.title}")`)
    }
  });

  // "ç²‰å°ˆåç¨±+ç²‰å°ˆç¶²å€"ä½œç‚ºå¯«å…¥è¿½è¹¤äººæ•¸æ¬„ä½çš„åˆ¤æ–·
  let trace_array = []
  online_title_array.forEach(title => {
    let fanpage = result_array.find(fanpage => `=HYPERLINK("${fanpage.url}","${fanpage.title}")` == title)
    if (fanpage) {
      trace_array.push([fanpage.trace])
    } else {
      trace_array.push([])
    }
  });

  const datetime = new Date()
  if (online_title_array[0] !== title) {//å¦‚æœæ˜¯å…¨æ–°çš„sheetå°±æœƒåœ¨é–‹é ­æ’å…¥
    online_title_array.unshift(title)
    trace_array.unshift([dateFormat(datetime, "GMT:yyyy/mm/dd")])
  } else {//å¦‚æœä¸æ˜¯å…¨æ–°å°±å–ä»£
    trace_array[0] = [dateFormat(datetime, "GMT:yyyy/mm/dd")]
  }
  
  await writeTitle(title, online_title_array.map(title => [title]), auth)
  let lastCol = await getLastCol(title, auth)
  await writeTrace(title, trace_array, lastCol, auth)
}
```

----

ğŸš€ åŸ·è¡Œç¨‹å¼
----
æœ¬æ¬¡ç›®æ¨™éœ€å¤šæ¬¡åŸ·è¡Œç¨‹å¼ä½ æ‰èƒ½ç¢ºä¿ç¨‹å¼é‹ä½œæ­£ç¢º
1. ä¾ç…§è‡ªå·±çš„æƒ³æ³•å»ç·¨ä¿®ç·šä¸Šçš„Google Sheetsã€èª¿æ•´çˆ¬èŸ²jsonå…§å®¹
2. åœ¨å°ˆæ¡ˆè³‡æ–™å¤¾çš„çµ‚ç«¯æ©Ÿ(Terminal)åŸ·è¡ŒæŒ‡ä»¤
    ```vim
    yarn start
    ```
3. åœ¨çˆ¬èŸ²è·‘å®Œå¾Œçœ‹çœ‹ç·šä¸Šçš„Google Sheetsæ˜¯å¦æœ‰ä¾ç…§ä½ çš„æ›´æ”¹æ­£ç¢ºå¯«å…¥

* ä¸‹åœ–æ˜¯æˆ‘å¤šæ¬¡ä¿®æ”¹ fb.json å¾ŒåŸ·è¡Œçˆ¬èŸ²çš„çµæœ  
    ![image](./article_img/googlesheets.png)

----

â„¹ï¸ å°ˆæ¡ˆåŸå§‹ç¢¼
----
* ä»Šå¤©çš„å®Œæ•´ç¨‹å¼ç¢¼å¯ä»¥åœ¨[é€™è£¡](https://github.com/dean9703111/ithelp_30days/tree/master/day21)æ‰¾åˆ°å–”
* æˆ‘ä¹Ÿè²¼å¿ƒåœ°æŠŠæ˜¨å¤©çš„æŠŠæ˜¨å¤©çš„ç¨‹å¼ç¢¼æ‰“åŒ…æˆ[å£“ç¸®æª”](https://github.com/dean9703111/ithelp_30days/raw/master/sampleCode/day18_sample_code.zip)ï¼Œä½ å¯ä»¥ç”¨è£¡é¢ä¹¾æ·¨çš„ç’°å¢ƒä¾†å¯¦ä½œä»Šå¤©Google Sheetsçš„èµ·æ‰‹å¼å–”
    * è«‹è¨˜å¾—åœ¨çµ‚ç«¯æ©Ÿä¸‹æŒ‡ä»¤ **yarn** æ‰æœƒæŠŠä¹‹å‰çš„å¥—ä»¶å®‰è£
    * è¦åœ¨tools/google_sheetsè³‡æ–™å¤¾æ”¾ä¸Šè‡ªå·±çš„æ†‘è­‰
    * èª¿æ•´fanspagesè³‡æ–™å¤¾å…§ç›®æ¨™çˆ¬èŸ²çš„ç²‰å°ˆç¶²å€
    * èª¿æ•´.envæª”
        * å¡«ä¸ŠFBç™»å…¥è³‡è¨Š
        * å¡«ä¸ŠFBç‰ˆæœ¬(classic/new)
        * å¡«ä¸ŠIGç™»å…¥è³‡è¨Š
        * å¡«ä¸ŠSPREADSHEET_ID
        
### [Day22 Google Sheets-æ¥­ä¸»ï¼šæˆ‘å¸Œæœ›æ–°è³‡æ–™æ’åœ¨æœ€å‰é¢ & è«‡éœ€æ±‚è®Šæ›´](/day22/README.md)