#### [å›ç›®éŒ„](../README.md)
## Day25 æ’ç¨‹-ç”¨foreverå¥—ä»¶ä¾†æ§ç®¡æ’ç¨‹ï¼ŒèƒŒæ™¯åŸ·è¡Œæ‰æ˜¯ç‹é“ï¼

>å¦‚æœä¸€å€‹å¥—ä»¶ç„¡æ³•è§£æ±ºå•é¡Œï¼Œé‚£å°±ç”¨å…©å€‹å§ï¼

ğŸ¤” æ€è€ƒä¸€ä¸‹æ˜¨å¤©çš„æ’ç¨‹æœ‰ä»€éº¼ç¼ºé»
----
**æ˜¨å¤©å®Œæˆçš„æ’ç¨‹å…¶å¯¦æœ‰å¹¾å€‹ç¼ºé»ï¼š**
1. åœ¨çµ‚ç«¯æ©Ÿ(Terminal)åŸ·è¡Œæ’ç¨‹å¾Œä½ `å¿…é ˆä¿æŒé–‹å•Ÿ`çš„ç‹€æ…‹ä½ æ‰çŸ¥é“ä»–æœ‰æ²’æœ‰æ­£ç¢ºåŸ·è¡Œ
2. å¦‚æœä¸å°å¿ƒæŠŠåŸ·è¡Œä¸­çš„çµ‚ç«¯æ©Ÿ(Terminal)é—œæ‰ä½ æœƒå¾ˆå›°æ“¾ï¼Œå› ç‚ºä½ é—œæ‰çš„æ˜¯çµ‚ç«¯æ©Ÿä¸æ˜¯æ’ç¨‹ï¼Œéœ€è¦ç”¨`éº»ç…©çš„è¾¦æ³•æ‰èƒ½ç æ‰é€™å€‹æ’ç¨‹`
3. ç®¡ç†å›°é›£ï¼Œ`å•Ÿå‹•ã€åœæ­¢ã€é‡å•Ÿä½ éƒ½è¦åœ¨å°ˆæ¡ˆè³‡æ–™å¤¾`ä¸‹è™•ç†
4. å¦‚æœé‹è¡Œéç¨‹ä¸­ç¨‹å¼`æ„å¤–é—œé–‰éœ€è¦æ‰‹å‹•é‡é–‹`
5. åœ¨æ’ç¨‹`é‹è¡Œä¸­ä½ ä¿®æ”¹çˆ¬èŸ²jsonè£¡é¢çš„ç²‰çµ²å°ˆé åˆ—è¡¨æ˜¯ç„¡æ•ˆçš„`ï¼Œä½ æœƒç™¼ç¾è§¸ç™¼çˆ¬èŸ²æ™‚ä»–è·‘çš„æ˜¯èˆŠç‰ˆçš„ç²‰çµ²åˆ—è¡¨

----

ğŸ† ä»Šæ—¥ç›®æ¨™
----
1. ç æ‰åŸ·è¡Œä¸­çš„æ’ç¨‹
2. ä½¿ç”¨å¥—ä»¶ `forever` ä¾†ç®¡ç†æ’ç¨‹
3. åœ¨ package.json ä¸­åŠ å…¥é©…å‹• forever çš„ scripts

----

# 1. ç æ‰åŸ·è¡Œä¸­çš„æ’ç¨‹
æˆ‘æƒ³å¾ˆå¤šäººè·Ÿæˆ‘ä¸€æ¨£ä¸å°å¿ƒé †æ‰‹æŠŠçµ‚ç«¯æ©Ÿ(Terminal)çµ¦é—œäº† (æˆ–æ˜¯å¾ˆä¹¾è„†åœ°æŠŠVScodeé—œäº†)ï¼Œä½†æ˜¯`è¦–çª—é—œé–‰å¾Œæ’ç¨‹å…¶å¯¦åœ¨èƒŒæ™¯é‚„æ˜¯åœ¨æŒçºŒé‹è¡Œçš„`ï¼Œä¸‹é¢æä¾›ä¸€å€‹å¿«é€Ÿçš„è§£æ±ºæ–¹æ¡ˆï¼š
```vim
ps aux | grep [æœå°‹é—œéµå­—]
kill [ç¨‹å¼çš„PID]
```

##### ps (process status) é¡¯ç¤ºé€²ç¨‹ç‹€æ…‹çš„æŒ‡ä»¤
* åƒæ•¸èªªæ˜
    * a : åˆ—å‡ºæ‰€æœ‰ä½¿ç”¨è€…èˆ‡terminalç„¡é—œçš„æ‰€æœ‰process
    * u : ä»¥ä½¿ç”¨è€…åç¨±é¡¯ç¤ºçš„æ ¼å¼
    * x : åˆ—å‡ºèˆ‡terminalæœ‰é—œçš„æ‰€æœ‰process(é€šå¸¸èˆ‡aæ­é…ä½¿ç”¨)
* é¡¯ç¤ºæ¬„ä½ : USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND  

##### kill - åˆªé™¤åŸ·è¡Œä¸­çš„ process
æˆ‘å€‘éœ€è¦æ‰¾åˆ°åŸ·è¡Œç¨‹å¼çš„ process PID æ‰èƒ½å°‡å…¶åˆªé™¤ï¼Œ`PID å°±åœ¨ç¬¬äºŒå€‹æ¬„ä½`ï¼Œè¤‡è£½èµ·ä¾†åŸ·è¡Œä¸‹é¢æŒ‡ä»¤å°±èƒ½åˆªé™¤åš•
```vim
kill [ç¨‹å¼çš„PID]
```

### å¯¦éš›æ“ä½œç¯„ä¾‹
1. å…ˆæ‰¾å‡ºæ­£åœ¨é€²è¡Œçš„æ’ç¨‹
    ```vim
    ps aux | grep cron.js
    ```    
    ![image](./article_img/ps_aux.png)
2. ä½ å¯ä»¥çœ‹åˆ°åŸ·è¡Œæ’ç¨‹çš„ PID æ˜¯ 49915ï¼ŒæŠŠä»–è¤‡è£½èµ·ä¾†ç”¨ kill æŒ‡ä»¤åˆªé™¤
    ```vim
    kill 49915
    ```
    åˆªé™¤å®Œå¾Œå†æ¬¡ç¢ºèªæ˜¯å¦åˆªé™¤æˆåŠŸ
    ```vim
    ps aux | grep cron.js
    ```
    ![image](./article_img/kill.png)

----

# 2. ä½¿ç”¨å¥—ä»¶ `forever` ä¾†ç®¡ç†æ’ç¨‹
å› ç‚ºå–®ç´”ä½¿ç”¨ cronå¥—ä»¶ æœƒè®“ä½ é‡åˆ°é–‹é ­æ‰€èªªçš„å„ç¨®å•é¡Œï¼Œæ‰€ä»¥é‡åˆ°éé€™å€‹å•é¡Œçš„é«˜æ‰‹å€‘ä¹Ÿå¯«äº†ä¸€å€‹`åœ¨ Node.js ä¸­å°ˆé–€ç®¡ç†æ’ç¨‹çš„çš„å¥—ä»¶ï¼šforever`ï¼Œé€™å€‹å¥—ä»¶æ“ä½œæ¥µå…¶ç°¡å–®ï¼Œä¸åƒ…èƒ½è®“æ’ç¨‹åœ¨èƒŒæ™¯ç©©å®šåŸ·è¡Œï¼Œé‚„èƒ½åœ¨çµ‚ç«¯æ©Ÿçš„ä»»ä½•ä½ç½®åšç®¡ç†
* é¦–å…ˆè¦è«‹ä½ `å…¨åŸŸå®‰è£`é€™å€‹å¥—ä»¶ï¼Œé€™æ¨£æ‰èƒ½åœ¨ä»»ä½•ä¸€å€‹ä½ç½®åŸ·è¡Œå®ƒ  
    ```vim
    yarn add global forever
    ```
* åŸºç¤æŒ‡ä»¤(ä»¥æœ¬å°ˆæ¡ˆcron.jsç‚ºç¯„ä¾‹)
    * **å•Ÿå‹•ç¨‹å¼**
        ```vim
        forever --minUptime=1000 --spinSleepTime=1000 start tools/cron.js
        ```
        > å¦‚æœä½ æ²’åŠ ä¸Š `--minUptime=1000 --spinSleepTime=1000` çš„åƒæ•¸ æœƒæœ‰è­¦å‘Šå¦‚ä¸‹åœ–
            ![image](./article_img/foreverstart.png)
    * **ç›£è½æª”æ¡ˆæ›´å‹•ä¸¦è‡ªå‹•é‡å•Ÿ**
        ```vim
        forever --minUptime=1000 --spinSleepTime=1000 -w start tools/cron.js
        ```
        * é€™å€‹æŒ‡ä»¤å¯ä»¥`ç›£æ§æª”æ¡ˆçš„è®Šæ›´`ï¼Œè§£æ±ºéå»çˆ¬èŸ²jsonè³‡æ–™è®Šæ›´ä½†æ˜¯åŸ·è¡Œæ™‚è·‘èˆŠè³‡æ–™çš„å•é¡Œ
        * å°ˆæ¡ˆè³‡æ–™å¤¾åº•ä¸‹`æ–°å¢ .foreverignore çš„æª”æ¡ˆ`ï¼Œä¸éœ€è¦å»åµæ¸¬é€™äº›æª”æ¡ˆ/è³‡æ–™å¤¾çš„è®Šæ›´  
            #### .foreverignore
            ```
            node_modules
            .env
            chromedriver.exe
            debug.log
            ```
    * **é¡¯ç¤ºæ‰€æœ‰é‹è¡Œçš„ç‹€æ…‹**
        ```
        forever list
        ```
        ![image](./article_img/foreverlist.png)
        * å¯ä»¥åœ¨ `logfile` è£¡é¢çœ‹åˆ°æ’ç¨‹åŸ·è¡Œçš„ç‹€æ³
    * **é—œé–‰æ‰€æœ‰æ’ç¨‹**
        ```
        forever stopall
        ```
        ![image](./article_img/foreverstopall.png)  
    * **é‡æ–°å•Ÿå‹•ç¨‹å¼**
        * è«‹æ³¨æ„å¦‚æœä½  `ä¿®æ”¹äº† .env è£¡é¢çš„è³‡æ–™ï¼Œå‰‡å¿…é ˆè¦é‡å•Ÿæ‰æœƒç”Ÿæ•ˆ`
        ```
        forever restart tools/cron.js
        ```
* åŸ·è¡Œ forever æ™‚æœƒé‡åˆ°è­¦å‘Šçš„åŸå› 
    å¦‚æœä½ çš„ Node.js ç‰ˆæœ¬å‡ç´šåˆ° v14 ä¹‹å¾Œæœƒç™¼ç¾é€™å€‹å¥—ä»¶åŸ·è¡Œçš„æ™‚å€™æœƒæœ‰è­¦å‘Šå¦‚ä¸‹ï¼š
    ```
    (node:30512) Warning: Accessing non-existent property 'padLevels' of module exports inside circular dependency
    ```
    * é€™å€‹è­¦å‘Šæ˜¯å› ç‚º forever æœ‰ç›¸ä¾å¥—ä»¶åœ¨ node v14 ä¹‹å¾Œä¸å†æ”¯æ´ï¼Œ`ä½†é€™äº›è­¦å‘Šä¸å½±éŸ¿å¥—ä»¶é‹è¡Œ`
    * Node.js çš„ç‰ˆæœ¬æ›´æ–°çš„éå¸¸å¿«é€Ÿï¼Œè¨±å¤šå¥—ä»¶éƒ½å¯èƒ½åœ¨æ›´æ–°å¾Œä¸æ”¯æ´ï¼Œ`æ‰€ä»¥æ›´æ–°ç‰ˆæœ¬å¾Œè«‹åˆ‡è¨˜è¦é‹è¡Œä¸€æ¬¡ç¢ºä¿æ­£å¸¸`
    
    >ç­†è€…å¯«é€™ä»½å°ˆæ¡ˆçš„æ™‚å€™ node ç‰ˆæœ¬æ‰ 12.6ï¼Œæ²’å¹¾å€‹æœˆå°±å‡ºåˆ° 14 ç‰ˆï¼Œä¹Ÿè¨±æœªä¾†æŸä¸€å¤©æœ‰äººçœ‹åˆ°é€™ç¯‡æ–‡ç« çš„æ™‚å€™ node ç‰ˆæœ¬å°±ç ´ 20 äº†
----

# 3. åœ¨ package.json ä¸­åŠ å…¥é©…å‹• forever çš„ scripts
å°‡æ˜¨å¤© cron çš„ scripts æ”¹ç‚ºä½¿ç”¨ forever çš„ç‰ˆæœ¬
* ç‚ºäº†é¿å…é‡è¤‡å•Ÿå‹•ï¼Œæ‰€ä»¥æˆ‘æ¡å–å…ˆæš«åœæ‰€æœ‰é‹è¡Œçš„foreverç¨‹å¼ï¼Œç„¶å¾Œå†å•Ÿå‹•ç¨‹å¼
```json
"forever":"forever stopall && forever --minUptime=1000 --spinSleepTime=1000 -w start tools/cron.js"
```

----

ğŸš€ åŸ·è¡Œç¨‹å¼
----
1. åœ¨å°ˆæ¡ˆè³‡æ–™å¤¾çš„çµ‚ç«¯æ©Ÿ(Terminal)åŸ·è¡ŒæŒ‡ä»¤å•Ÿå‹•æ’ç¨‹
    ```vim
    yarn forever
    ```
    ![image](./article_img/terminal.png)  
2. ç„¶å¾Œå†åŸ·è¡ŒæŒ‡ä»¤ **forever list** ç¢ºèªæ’ç¨‹æ­£åœ¨èƒŒæ™¯é‹è¡Œ  
    ![image](./article_img/terminal2.png)  

----

â„¹ï¸ å°ˆæ¡ˆåŸå§‹ç¢¼
----
* ä»Šå¤©çš„å®Œæ•´ç¨‹å¼ç¢¼å¯ä»¥åœ¨[é€™è£¡](https://github.com/dean9703111/ithelp_30days/tree/master/day25)æ‰¾åˆ°å–”
* æˆ‘ä¹Ÿè²¼å¿ƒåœ°æŠŠæ˜¨å¤©çš„æŠŠæ˜¨å¤©çš„ç¨‹å¼ç¢¼æ‰“åŒ…æˆ[å£“ç¸®æª”](https://github.com/dean9703111/ithelp_30days/raw/master/sampleCode/day24_sample_code.zip)ï¼Œä½ å¯å·²åœ¨ä¹¾æ·¨çš„ç’°å¢ƒå˜—è©¦ç”¨foreverä¾†æ§ç®¡æ’ç¨‹å§
    * è«‹è¨˜å¾—åœ¨çµ‚ç«¯æ©Ÿä¸‹æŒ‡ä»¤ **yarn** æ‰æœƒæŠŠä¹‹å‰çš„å¥—ä»¶å®‰è£
    * è¦åœ¨tools/google_sheetsè³‡æ–™å¤¾æ”¾ä¸Šè‡ªå·±çš„æ†‘è­‰
    * èª¿æ•´fanspagesè³‡æ–™å¤¾å…§ç›®æ¨™çˆ¬èŸ²çš„ç²‰å°ˆç¶²å€
    * èª¿æ•´.envæª”
        * å¡«ä¸ŠFBç™»å…¥è³‡è¨Š
        * å¡«ä¸ŠFBç‰ˆæœ¬(classic/new)
        * å¡«ä¸ŠIGç™»å…¥è³‡è¨Š
        * å¡«ä¸ŠSPREADSHEET_ID
        * å¡«ä¸Šçˆ¬èŸ²åŸ·è¡Œæ™‚é–“(CRONJOB_TIME)
    * åœ¨çµ‚ç«¯æ©Ÿä¸‹æŒ‡ä»¤ **yarn add global forever** ï¼Œè®“ä½ åœ¨çµ‚ç«¯æ©Ÿçš„ä»»ä½•ä½ç½®éƒ½èƒ½ç®¡æ§æ’ç¨‹

ğŸ“– åƒè€ƒè³‡æº
----
1. [å¦‚æœctrl + cæ²’æ³•çµ‚æ­¢æ€éº¼è¾¦?](https://medium.com/mess-up/%E5%A6%82%E6%9E%9Cctrl-c%E6%B2%92%E6%B3%95%E7%B5%82%E6%AD%A2%E6%80%8E%E9%BA%BC%E8%BE%A6-5e720fd66e32)
2. [Linux ç¨‹åºç®¡ç† ( ps -l / ps aux / ps axjf )](http://puremonkey2010.blogspot.com/2011/02/linux-linux-ps-l-ps-aux-ps-axjf.html)
3. [[Node.jsæ‰“é€ API] ä½¿ç”¨foreveré‹è¡ŒAPIæ°¸é ä¸åœæ­¢](https://andy6804tw.github.io/2018/01/17/api-forever/)

### [Day26 æ’ç¨‹-é‡é–‹æ©Ÿå¾Œæ’ç¨‹ä¸è¦‹æƒ¹ï¼Ÿç°¡å–®å¹¾å€‹æ­¥é©Ÿï¼Œå¾æ­¤ä»¥å¾Œå®Œå…¨è‡ªå‹•](/day26/README.md)